name: Django CI/CD Pipeline

on:
  push:
    branches:
      - main
      - development

jobs:
  test:
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    
    env:
      CI: true
      GITHUB_ACTIONS: true
      
      DEBUG: False
      
      DB_NAME: test_db
      DB_USER: postgres
      DB_PASSWORD: postgres
      DB_HOST: localhost
      DB_PORT: 5432
      
      SUPABASE_URL: https://test.supabase.co
      SUPABASE_KEY: test-key-for-ci-only
      SUPABASE_SERVICE_KEY: test-service-key-for-ci-only
      SUPABASE_JWT_SECRET: test-jwt-secret-for-ci-only
      
      EMAIL_BACKEND: django.core.mail.backends.console.EmailBackend
      EMAIL_HOST: smtp.gmail.com
      EMAIL_PORT: 587
      EMAIL_USE_TLS: True
      EMAIL_HOST_USER: test@example.com
      EMAIL_HOST_PASSWORD: test-password
      DEFAULT_FROM_EMAIL: test@example.com
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Free Disk Space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          df -h
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Upgrade pip
        run: |
          python -m pip install --upgrade pip setuptools wheel

      - name: Ensure SECRET_KEY exists for CI
        run: |
          if [ -z "${{ secrets.DJANGO_SECRET_KEY }}" ]; then
            echo "SECRET_KEY=ci_test_secret_change_me" >> $GITHUB_ENV
          else
            echo "SECRET_KEY=${{ secrets.DJANGO_SECRET_KEY }}" >> $GITHUB_ENV
          fi
      
      - name: Install PyTorch (CPU-only for CI)
        run: |
          pip install --no-cache-dir torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cpu
      
      - name: Install ML/NLP dependencies
        run: |
          pip install --no-cache-dir transformers==4.36.2
          pip install --no-cache-dir datasets==2.16.1
          pip install --no-cache-dir huggingface-hub==0.20.0
          pip install --no-cache-dir scikit-learn==1.4.0
          pip install --no-cache-dir pandas==2.2.0
          pip install --no-cache-dir numpy==1.26.0
          pip install --no-cache-dir scipy==1.12.0
      
      - name: Install Django and web dependencies
        run: |
          pip install --no-cache-dir Django==5.0.2
          pip install --no-cache-dir djangorestframework==3.14.0
          pip install --no-cache-dir djangorestframework-simplejwt==5.5.1
          pip install --no-cache-dir djoser==2.3.3
          pip install --no-cache-dir django-allauth==65.7.0
          pip install --no-cache-dir django-cors-headers==4.3.1
          pip install --no-cache-dir dj-rest-auth==7.0.1
          pip install --no-cache-dir drf-yasg==1.21.10
          pip install --no-cache-dir psycopg2-binary==2.9.10
          pip install --no-cache-dir dj-database-url==2.3.0
          pip install --no-cache-dir gunicorn==23.0.0
          pip install --no-cache-dir whitenoise==6.11.0
      
      - name: Install utility dependencies
        run: |
          pip install --no-cache-dir python-decouple==3.8
          pip install --no-cache-dir python-dotenv==1.0.1
          pip install --no-cache-dir django-decouple==2.1
          pip install --no-cache-dir Pillow==10.4.0
          pip install --no-cache-dir requests==2.31.0
          pip install --no-cache-dir supabase>=2.0.0
          pip install --no-cache-dir openai>=1.12.0
      
      - name: Verify PyTorch installation
        run: |
          python -c "import torch; print(f'PyTorch version: {torch.__version__}')"
          python -c "import transformers; print(f'Transformers version: {transformers.__version__}')"
      
      - name: Check Django setup
        run: |
          python manage.py check
      
      - name: Run migrations
        run: |
          python manage.py migrate --noinput
      
      - name: Run tests
        run: |
          python manage.py test --noinput
      
      - name: Check for missing migrations
        run: |
          python manage.py makemigrations --check --dry-run --noinput

  deploy-prod:
    needs: test
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://cariex.onrender.com
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Validate Deploy Hook URL
        run: |
          if [ -z "${{ secrets.RENDER_DEPLOY_HOOK_URL }}" ]; then
            echo "âŒ Error: RENDER_DEPLOY_HOOK_URL secret is not set"
            exit 1
          fi
          echo "âœ… Deploy hook URL is configured"
      
      - name: Deploy to Render
        run: |
          response=$(curl -X POST "${{ secrets.RENDER_DEPLOY_HOOK_URL }}" \
            -H "Content-Type: application/json" \
            -w "\n%{http_code}" \
            -d '{}')
          
          http_code=$(echo "$response" | tail -n1)
          
          if [ "$http_code" -ge 200 ] && [ "$http_code" -lt 300 ]; then
            echo "âœ… Deployment triggered successfully (HTTP $http_code)"
          else
            echo "âŒ Deployment failed (HTTP $http_code)"
            exit 1
          fi
      
      - name: Wait for deployment
        run: |
          echo "â³ Waiting for deployment to complete..."
          sleep 30
      
      - name: Health check
        run: |
          max_attempts=10
          attempt=0
          
          while [ $attempt -lt $max_attempts ]; do
            attempt=$((attempt + 1))
            echo "ðŸ” Health check attempt $attempt/$max_attempts..."
            
            if curl -f -s -o /dev/null "https://cariex.onrender.com/"; then
              echo "âœ… Application is healthy!"
              exit 0
            fi
            
            if [ $attempt -lt $max_attempts ]; then
              echo "â³ Waiting 30 seconds before next attempt..."
              sleep 30
            fi
          done
          
          echo "âš ï¸ Health check did not pass after $max_attempts attempts"
          echo "Please check Render dashboard manually"
      
      - name: Deployment Summary
        if: always()
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: Production" >> $GITHUB_STEP_SUMMARY
          echo "- **URL**: https://cariex.onrender.com" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the [Render Dashboard](https://dashboard.render.com/) for detailed deployment logs" >> $GITHUB_STEP_SUMMARY

